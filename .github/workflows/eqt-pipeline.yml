name: EQT Kanban Advanced Automation (Final Runnable Version)

on:
  workflow_dispatch:
    inputs:
      contentType:
        description: 'Content Type (Issue æˆ– PullRequest)'
        required: true
        default: 'Issue'
        type: choice
        options:
        - Issue
        - PullRequest
      contentNumber:
        description: 'Issue æˆ– PR ç¼–å·'
        required: true
        type: number
        default: "000001"
      triggerAI:
        description: 'åŒæ—¶è§¦å‘ AI Bot åˆ†æ'
        required: false
        type: boolean
        default: false
  issues:
    types: [opened, labeled, unlabeled, closed, reopened, edited]
  pull_request:
    types: [opened, closed, reopened, ready_for_review, edited, labeled, unlabeled]
  project_card:
    types: [created, moved, deleted]


jobs:
  automate-status:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸŒ± æ–° Issue è‡ªåŠ¨æ·»åŠ åˆ°é¡¹ç›®å¹¶è®¾ä¸ºæ–°èŠ½"
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: actions/github-script@v7
        env:
          GH_PAT: ${{ secrets.GH_PROJECT_PAT }}
          EQT_PROJECT_NODE_ID: ${{ secrets.EQT_PROJECT_NODE_ID }}
          STATUS_FIELD_ID: ${{ secrets.STATUS_FIELD_ID }}
          SEED_OPTION_ID: ${{ secrets.SEED_OPTION_ID }}
        with:
          github-token: ${{ secrets.GH_PROJECT_PAT }}
          script: |
            try {
              const projectId = process.env.EQT_PROJECT_NODE_ID.trim();
              const fieldId = process.env.STATUS_FIELD_ID.trim();
              const optionId = process.env.SEED_OPTION_ID.trim();
              const issueNodeId = context.payload.issue.node_id;

              core.info(`âœ… projectId=${projectId}`);
              core.info(`âœ… fieldId=${fieldId}`);
              core.info(`âœ… optionId=${optionId}`);

              // 1ï¸âƒ£ æŠŠ Issue æ·»åŠ åˆ° Project
              const addMutation = `
              mutation {
                addProjectV2ItemById(input: {
                  projectId: "${projectId}",
                  contentId: "${issueNodeId}"
                }) {
                  item { id }
                }
              }`;

              // å‘å‡º GraphQL è¯·æ±‚
              const addResult = await github.graphql(addMutation);
              const itemId = addResult.addProjectV2ItemById.item.id;
              core.info(`âœ… å·²æ·»åŠ åˆ°é¡¹ç›® itemId=${itemId}`);

              // 2ï¸âƒ£ æ›´æ–°çŠ¶æ€å­—æ®µä¸ºâ€œğŸŒ± æ–°èŠ½â€
              const updateMutation = `
              mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${projectId}",
                  itemId: "${itemId}",
                  fieldId: "${fieldId}",
                  value: { singleSelectOptionId: "${optionId}" }
                }) {
                  projectV2Item { id }
                }
              }`;
              
              // 3ï¸âƒ£ æ·»åŠ æ ‡ç­¾
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ["ğŸŒ±-seed"]
              });
              core.info("âœ… å·²æ·»åŠ æ ‡ç­¾ ğŸŒ±-seed");

              await github.graphql(updateMutation);
              core.info("âœ… å·²æ›´æ–°çŠ¶æ€å­—æ®µä¸º ğŸŒ± æ–°èŠ½");

              // 4ï¸âƒ£ æ›´æ–° Issue æ¨¡æ¿æ­£æ–‡
              const template = [
                "## ğŸ¯ EQTç ”ç©¶æµç¨‹",
                "",
                "**å½“å‰é˜¶æ®µ**: ğŸŒ± æ–°èŠ½",
                "**ä¼˜å…ˆçº§**: [è¯·é€‰æ‹©]",
                "**é¢†åŸŸ**: [è¯·é€‰æ‹©]",
                "**AIéœ€æ±‚**:",
                "**é¢„æµ‹**:",
                "**ä¸“å®¶**:",
                "",
                "---",
                "*ç”± EQT Pipeline è‡ªåŠ¨åˆ›å»º*"
              ].join("\n");

              const originalBody = context.payload.issue.body || "";
              await github.rest.issues.update({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `${template}\n\n${originalBody}`
              });
              core.info("âœ… Issue æ¨¡æ¿å·²æ›´æ–°");
              
              // æ‰“å°è¯·æ±‚ç»“æœ
              core.info(`âœ… Add Result: ${JSON.stringify(addResult)}`);

            } catch (error) {
              core.setFailed(`âŒ å‡ºé”™å•¦: ${error.message}`);
              if (error.errors) {
                core.error(JSON.stringify(error.errors, null, 2));
              }
            }
