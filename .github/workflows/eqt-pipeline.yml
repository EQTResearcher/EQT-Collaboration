name: EQT Pipeline Automation (V2)

on:
  issues:
    types: [opened]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  automate-status:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸŒ± æ–° Issue è‡ªåŠ¨æ·»åŠ åˆ°é¡¹ç›®å¹¶è®¾ä¸ºæ–°èŠ½
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: actions/github-script@v7
        env:
          GH_PAT: ${{ secrets.GH_PROJECT_PAT }}
          EQT_PROJECT_NODE_ID: ${{ secrets.EQT_PROJECT_NODE_ID }}
          STATUS_FIELD_ID: ${{ secrets.STATUS_FIELD_ID }}
          SEED_OPTION_ID: ${{ secrets.SEED_OPTION_ID }}
        with:
          github-token: ${{ secrets.GH_PROJECT_PAT }}
          script: |
            const clean = (v) => v ? v.trim().replace(/^"|"$/g, '') : v;

            const projectId = clean(process.env.EQT_PROJECT_NODE_ID);
            const fieldId = clean(process.env.STATUS_FIELD_ID);
            const optionId = clean(process.env.SEED_OPTION_ID);

            try {
              core.info(`ğŸ” Using projectId=${projectId}`);
              core.info(`ğŸ” Using fieldId=${fieldId}`);
              core.info(`ğŸ” Using optionId=${optionId}`);

              // 1ï¸âƒ£ æŠŠ Issue æ·»åŠ åˆ° ProjectV2
              const addMutation = `
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId,
                    contentId: $contentId
                  }) {
                    item { id }
                  }
                }
              `;
              const addResult = await github.graphql(addMutation, {
                projectId,
                contentId: context.payload.issue.node_id
              });
              const itemId = addResult.addProjectV2ItemById.item.id;
              core.info(\`âœ… Added issue to project itemId=\${itemId}\`);

              // 2ï¸âƒ£ æ›´æ–°çŠ¶æ€å­—æ®µä¸ºâ€œğŸŒ± æ–°èŠ½â€
              const updateMutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: ID!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: {singleSelectOptionId: $optionId}
                  }) {
                    projectV2Item { id }
                  }
                }
              `;
              await github.graphql(updateMutation, {
                projectId,
                itemId,
                fieldId,
                optionId
              });
              core.info("âœ… Updated project field status to ğŸŒ± æ–°èŠ½");

              // 3ï¸âƒ£ æ·»åŠ æ ‡ç­¾
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ["ğŸŒ±-seed"]
              });
              core.info("âœ… Added label ğŸŒ±-seed");

              // 4ï¸âƒ£ æ›´æ–° Issue æ¨¡æ¿
              const template = [
                "## ğŸ¯ EQTç ”ç©¶æµç¨‹",
                "",
                "**å½“å‰é˜¶æ®µ**\\: ğŸŒ± æ–°èŠ½",
                "**ä¼˜å…ˆçº§**\\: [è¯·é€‰æ‹©]",
                "**é¢†åŸŸ**\\: [è¯·é€‰æ‹©]",
                "**AIéœ€æ±‚**\\:",
                "**é¢„æµ‹**\\:",
                "**ä¸“å®¶**\\:",
                "",
                "---",
                "*ç”± EQT Pipeline è‡ªåŠ¨åˆ›å»º*"
              ].join("\\n");

              const originalBody = context.payload.issue.body || "";
              await github.rest.issues.update({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: template + "\\n\\n" + originalBody
              });
              core.info("âœ… Updated issue body successfully");

            } catch (error) {
              core.setFailed(`âŒ å‡ºé”™å•¦: ${error.message}`);
              if (error.errors) {
                core.error(JSON.stringify(error.errors, null, 2));
              }
            }
