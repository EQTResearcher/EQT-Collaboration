name: EQT Pipeline Automation
on:
  issues:
    types: [opened, labeled, closed, reopened, assigned]
  pull_request:
    types: [opened, synchronize, closed, review_requested]
  workflow_dispatch:

jobs:
  automate-status:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: è‡ªåŠ¨è®¾ç½®æ–°Issueåˆ°ğŸŒ±æ–°èŠ½
      uses: actions/github-script@v7
      if: github.event.action == 'opened' && github.event.issue.pull_request == null
      with:
        script: |
          await github.rest.projects.createCard({
            column_id: "${{ secrets.SEED_OPTION_ID }}",
            content_type: "Issue",
            content_id: context.issue.id
          });
          await github.rest.issues.update({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['ğŸŒ±-seed']
          });
          await github.rest.issues.update({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ¯ EQTç ”ç©¶æµç¨‹\n\n**å½“å‰é˜¶æ®µ**: ğŸŒ± æ–°èŠ½\n**ä¼˜å…ˆçº§**: [è¯·é€‰æ‹©]\n**é¢†åŸŸ**: [è¯·é€‰æ‹©]\n**AIéœ€æ±‚**: \n**é¢„æµ‹**: \n**ä¸“å®¶**: \n\n---\n*ç”± EQT Pipeline è‡ªåŠ¨åˆ›å»º*`
          });

    - name: ğŸ”æ ‡ç­¾ç§»åŠ¨åˆ°è®ºè¯ä¸­
      uses: actions/github-script@v7
      if: contains(github.event.issue.labels.*.name, 'ğŸ”') || contains(github.event.label.name, 'ğŸ”')
      with:
        script: |
          await github.rest.projects.updateCard({
            card_id: "${{ secrets.EXPLORING_CARD_ID }}", // éœ€è¦åŠ¨æ€è·å–
            column_id: "${{ secrets.EXPLORING_COLUMN_ID }}"
          });
          await github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['ğŸ”-exploring']
          });

    - name: ğŸ§ªéªŒè¯ä¸­ - é“¾æ¥æ•°æ®ä»“åº“
      uses: actions/github-script@v7
      if: contains(github.event.issue.body, 'EQT-Data') || contains(github.event.label.name, 'ğŸ§ª')
      with:
        script: |
          // ç§»åŠ¨åˆ°éªŒè¯åˆ—
          await github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['ğŸ§ª-validating']
          });

    - name: PRåˆå¹¶ â†’ ğŸ¯æ ¸å¿ƒæ•´åˆ
      if: github.event.pull_request.merged == true
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = context.payload.pull_request.head.ref.match(/issue-(\d+)/)?.[1];
          if (issueNumber) {
            await github.rest.issues.update({
              issue_number: parseInt(issueNumber),
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              labels: ['ğŸ¯-integrated']
            });
          }

  ai-bot-integration:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€æµ‹AIéœ€æ±‚å¹¶é€šçŸ¥Bot
      uses: actions/github-script@v7
      if: contains(github.event.issue.body, '@EQT-AI-Bot')
      env:
        AI_BOT_WEBHOOK: ${{ secrets.AI_BOT_WEBHOOK }}
      with:
        script: |
          const aiDemand = context.payload.issue.body.match(/@EQT-AI-Bot\s*(.+)/)?.[1];
          if (aiDemand) {
            await fetch(process.env.AI_BOT_WEBHOOK, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                issue: context.issue,
                command: aiDemand,
                action: 'analyze'
              })
            });
          }
