name: EQT Pipeline Automation (V2)
on:
  issues:
    types: [opened]
  workflow_dispatch:

permissions:
  issues: write
  contents: read
  repository-projects: write

jobs:
  automate-status:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸŒ± æ–° Issue è‡ªåŠ¨æ·»åŠ åˆ°é¡¹ç›®å¹¶è®¾ä¸ºæ–°èŠ½
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: actions/github-script@v7
        env:
          EQT_PROJECT_NODE_ID: ${{ secrets.EQT_PROJECT_NODE_ID }}
          STATUS_FIELD_ID: ${{ secrets.STATUS_FIELD_ID }}
          SEED_OPTION_ID: ${{ secrets.SEED_OPTION_ID }}
        with:
          script: |
            const projectId = process.env.EQT_PROJECT_NODE_ID;
            const fieldId = process.env.STATUS_FIELD_ID;
            const optionId = process.env.SEED_OPTION_ID;

            // æ·»åŠ é¡¹ç›®é¡¹
            const addMutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                  item { id }
                }
              }
            `;
            const addResult = await github.graphql(addMutation, {
              projectId,
              contentId: context.payload.issue.node_id
            });
            const itemId = addResult.addProjectV2ItemById.item.id;

            // æ›´æ–° Status ä¸º ğŸŒ± æ–°èŠ½
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: ID!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId,
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: {singleSelectOptionId: $optionId}
                }) {
                  projectV2Item { id }
                }
              }
            `;
            await github.graphql(updateMutation, { projectId, itemId, fieldId, optionId });

            // æ·»åŠ æ ‡ç­¾å’Œæ›´æ–° Issue body
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['ğŸŒ±-seed']
            });

            const template = `## ğŸ¯ EQTç ”ç©¶æµç¨‹\n\n**å½“å‰é˜¶æ®µ**: ğŸŒ± æ–°èŠ½\n**ä¼˜å…ˆçº§**: [è¯·é€‰æ‹©]\n**é¢†åŸŸ**: [è¯·é€‰æ‹©]\n**AIéœ€æ±‚**: \n**é¢„æµ‹**: \n**ä¸“å®¶**: \n\n---\n*ç”± EQT Pipeline è‡ªåŠ¨åˆ›å»º*`;
            const originalBody = context.payload.issue.body || '';
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: template + '\n\n' + originalBody
            });
