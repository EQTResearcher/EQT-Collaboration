name: EQT Kanban Advanced Automation

on:
  issues:
    types: [opened, labeled, unlabeled, closed, reopened]
  pull_request:
    types: [opened, closed, reopened, ready_for_review]
  project_card:
    types: [created, moved, deleted]

jobs:
  sync-status:
    runs-on: ubuntu-latest
    steps:
      - name: Sync labels to status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue, pull_request: pr } = context.payload;
            const contentType = issue ? 'Issue' : 'PullRequest';
            const contentNumber = issue?.number || pr?.number;
            
            if (!contentNumber) {
              console.log('âŒ æ²¡æœ‰æ‰¾åˆ° Issue æˆ– PR');
              return;
            }

            console.log(`â„¹ï¸ å¤„ç† ${contentType} #${contentNumber}`);

            try {
              // æ­¥éª¤1: æŸ¥è¯¢ç»„ç»‡/ä»“åº“çš„æ‰€æœ‰é¡¹ç›®ï¼Œæ‰¾åˆ°ç›®æ ‡é¡¹ç›®
              const projectSearchQuery = `
                query {
                  organization(login: "${context.repo.owner}") {
                    projectV2s(first: 20) {
                      nodes {
                        id
                        title
                        number
                        url
                      }
                    }
                  }
                  repository(owner: "${context.repo.owner}", name: "${context.repo.repo}") {
                    projectV2s(first: 20) {
                      nodes {
                        id
                        title
                        number
                        url
                      }
                    }
                  }
                }
              `;
              
              const { organization, repository } = await github.graphql(projectSearchQuery);
              
              // åˆå¹¶æ‰€æœ‰é¡¹ç›®å¹¶æŸ¥æ‰¾ç›®æ ‡é¡¹ç›®ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
              const allProjects = [
                ...(organization?.projectV2s?.nodes || []),
                ...(repository?.projectV2s?.nodes || [])
              ];
              
              const targetProject = allProjects.find(project => 
                project.title.toLowerCase().includes("eqt collective intelligence pipeline")
              );
              
              if (!targetProject) {
                console.log('âŒ æœªæ‰¾åˆ°é¡¹ç›® "EQT Collective Intelligence Pipeline"');
                console.log('å¯ç”¨é¡¹ç›®:');
                allProjects.forEach(p => {
                  console.log(`  - ${p.title} (ID: ${p.id}, Number: ${p.number}, URL: ${p.url})`);
                });
                return;
              }
              
              console.log(`âœ… æ‰¾åˆ°é¡¹ç›®: ${targetProject.title} (ID: ${targetProject.id}, Number: ${targetProject.number})`);

              // æ­¥éª¤2: è·å–é¡¹ç›®å­—æ®µï¼ˆç‰¹åˆ«æ˜¯ Status å­—æ®µï¼‰
              const fieldsQuery = `
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                          ... on ProjectV2FieldCommon {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const { node: projectNode } = await github.graphql(fieldsQuery, {
                projectId: targetProject.id
              });
              
              const fields = projectNode.fields.nodes;
              const statusField = fields.find(field => 
                field.name.toLowerCase().includes('status') || 
                field.name.includes('çŠ¶æ€') ||
                field.name.includes('é˜¶æ®µ')
              );
              
              if (!statusField || !statusField.options) {
                console.log('âŒ æœªæ‰¾åˆ° Status å•é€‰å­—æ®µ');
                console.log('å¯ç”¨å­—æ®µ:');
                fields.forEach(f => {
                  console.log(`  - ${f.name} (${f.__typename})`);
                  if (f.options) {
                    console.log(`    é€‰é¡¹: ${f.options.map(o => o.name).join(', ')}`);
                  }
                });
                return;
              }
              
              console.log(`âœ… æ‰¾åˆ°çŠ¶æ€å­—æ®µ: ${statusField.name} (ID: ${statusField.id})`);
              console.log(`çŠ¶æ€é€‰é¡¹: ${statusField.options.map(o => o.name).join(', ')}`);

              // æ ‡ç­¾åˆ°çŠ¶æ€çš„æ˜ å°„ï¼ˆç¡®ä¿ä¸é¡¹ç›®é€‰é¡¹å®Œå…¨åŒ¹é…ï¼‰
              const labelToStatus = {
                'exploring': 'ğŸ” è®ºè¯ä¸­ (Exploring)',
                'reviewing': 'ğŸ¤ ç¤¾åŒºè¯„å®¡ (Reviewing)', 
                'consensus': 'âœ… åˆæ­¥å…±è¯† (Consensus)',
                'integration': 'ğŸ¯ æ ¸å¿ƒæ•´åˆ (Integration)'
              };

              // è·å–å½“å‰æ ‡ç­¾
              const labels = issue?.labels || pr?.labels || [];
              console.log(`â„¹ï¸ å½“å‰æ ‡ç­¾: ${labels.map(l => l.name).join(', ') || 'æ— æ ‡ç­¾'}`);

              // æŸ¥æ‰¾åŒ¹é…çš„æ ‡ç­¾
              let targetStatusName = null;
              for (const [labelKey, statusName] of Object.entries(labelToStatus)) {
                if (labels.some(l => l.name.toLowerCase().includes(labelKey))) {
                  targetStatusName = statusName;
                  console.log(`âœ… åŒ¹é…æ ‡ç­¾: ${labelKey} -> ${statusName}`);
                  break;
                }
              }
              
              if (!targetStatusName) {
                console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„çŠ¶æ€æ ‡ç­¾ï¼Œè·³è¿‡æ›´æ–°');
                return;
              }

              // æŸ¥æ‰¾ç›®æ ‡çŠ¶æ€é€‰é¡¹
              const targetOption = statusField.options.find(opt => 
                opt.name === targetStatusName
              );
              
              if (!targetOption) {
                console.log(`âŒ æœªæ‰¾åˆ°çŠ¶æ€é€‰é¡¹: ${targetStatusName}`);
                console.log('å¯ç”¨é€‰é¡¹:', statusField.options.map(o => o.name));
                return;
              }
              
              console.log(`âœ… æ‰¾åˆ°ç›®æ ‡é€‰é¡¹: ${targetOption.name} (ID: ${targetOption.id})`);

              // æ­¥éª¤3: æ£€æŸ¥é¡¹ç›®é¡¹æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ·»åŠ 
              const contentId = `${contentType}:${context.repo.owner}/${context.repo.repo}#${contentNumber}`;
              console.log(`â„¹ï¸ Content ID: ${contentId}`);
              
              const itemQuery = `
                query($projectId: ID!, $contentId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 10, contentId: $contentId) {
                        nodes {
                          id
                          content {
                            ... on Issue {
                              number
                              title
                            }
                            ... on PullRequest {
                              number
                              title
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const { node: itemNode } = await github.graphql(itemQuery, {
                projectId: targetProject.id,
                contentId: contentId
              });
              
              let projectItem = itemNode.items.nodes[0];
              
              // å¦‚æœé¡¹ç›®é¡¹ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨æ·»åŠ 
              if (!projectItem) {
                console.log(`âš ï¸ æœªæ‰¾åˆ°é¡¹ç›®é¡¹ for ${contentId}ï¼Œå°è¯•æ·»åŠ ...`);
                
                const addItemMutation = `
                  mutation($projectId: ID!, $contentId: ID!) {
                    addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                      item {
                        id
                        content {
                          ... on Issue {
                            number
                            title
                          }
                          ... on PullRequest {
                            number
                            title
                          }
                        }
                      }
                    }
                  }
                `;
                
                const addResult = await github.graphql(addItemMutation, {
                  projectId: targetProject.id,
                  contentId: contentId
                });
                
                projectItem = addResult.addProjectV2ItemById.item;
                console.log(`âœ… æˆåŠŸæ·»åŠ é¡¹ç›®é¡¹: ${projectItem.id}`);
              } else {
                console.log(`âœ… æ‰¾åˆ°é¡¹ç›®é¡¹: ${projectItem.id} (${projectItem.content.title})`);
              }

              // æ­¥éª¤4: æ›´æ–°çŠ¶æ€
              const updateMutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $valueId: ID!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $valueId }
                  }) {
                    projectV2Item {
                      id
                      fieldValues(first: 10) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const { updateProjectV2ItemFieldValue } = await github.graphql(updateMutation, {
                projectId: targetProject.id,
                itemId: projectItem.id,
                fieldId: statusField.id,
                valueId: targetOption.id
              });
              
              console.log(`ğŸ‰ æˆåŠŸæ›´æ–°çŠ¶æ€ä¸º: ${targetStatusName}`);
              console.log(`é¡¹ç›®é¡¹ ID: ${projectItem.id}`);

            } catch (error) {
              console.error('âŒ æ‰§è¡Œå¤±è´¥:', error.message);
              if (error.errors) {
                error.errors.forEach(err => {
                  console.error(`GraphQL é”™è¯¯: ${err.message}`);
                  if (err.path) console.error(`è·¯å¾„: ${err.path.join('.')}`);
                });
              }
              console.error('å®Œæ•´é”™è¯¯:', JSON.stringify(error, null, 2));
              throw error;
            }

  ai-bot-trigger:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'ğŸŒ± seed')
    steps:
      - name: Trigger AI Bot analysis
        run: |
          echo "ğŸŒ± æ–°ç§å­è®®é¢˜ #${{ github.event.issue.number }} éœ€è¦AIåˆ†æ"
          echo "è®®é¢˜æ ‡é¢˜: ${{ github.event.issue.title }}"
          # æ›¿æ¢ä¸ºä½ çš„ AI Bot API è°ƒç”¨
          # curl -X POST https://your-ai-bot.com/analyze \
          #   -H "Authorization: Bearer $AI_BOT_TOKEN" \
          #   -d '{"issue": ${{ toJson(github.event.issue) }}}'
