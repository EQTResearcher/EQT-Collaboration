name: EQT Kanban Advanced Automation (Full Version)

on:
  issues:
    types: [opened, labeled, unlabeled, closed, reopened] # è¦†ç›–Issueå…¨ç”Ÿå‘½å‘¨æœŸ
  pull_request:
    types: [opened, closed, reopened, ready_for_review, edited] # æ–°å¢žPRç¼–è¾‘è§¦å‘ï¼ˆæ£€æµ‹ä»“åº“å…³è”ï¼‰
  project_card:
    types: [created, moved, deleted]

jobs:
  sync-status-full:
    runs-on: ubuntu-latest
    steps:
      - name: Sync labels to status (Full Stage Coverage)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // ========================= 1. åŸºç¡€æ•°æ®åˆå§‹åŒ– =========================
            const { issue, pull_request: pr } = context.payload;
            const contentType = issue ? 'Issue' : 'PullRequest';
            const contentNumber = issue?.number || pr?.number;
            const isIssueClosed = issue?.state === 'closed'; // æ ‡è®°Issueæ˜¯å¦å·²å…³é—­ï¼ˆç”¨äºŽå½’æ¡£ï¼‰
            
            if (!contentNumber) {
              console.log('âŒ æœªæ‰¾åˆ°æœ‰æ•ˆIssueæˆ–PRï¼Œç»ˆæ­¢æµç¨‹');
              return;
            }
            console.log(`ðŸ“¥ å¼€å§‹å¤„ç†ï¼š${contentType} #${contentNumber}ï¼ˆçŠ¶æ€ï¼š${isIssueClosed ? 'å·²å…³é—­' : 'æ´»è·ƒ'}ï¼‰`);

            try {
              // ========================= 2. é¡¹ç›®ä¸ŽçŠ¶æ€å­—æ®µæŸ¥è¯¢ =========================
              // 1. æŸ¥è¯¢ç›®æ ‡é¡¹ç›®ï¼ˆEQT Collective Intelligence Pipelineï¼‰
              const projectQuery = `
                query {
                  repository(owner: "${context.repo.owner}", name: "${context.repo.repo}") {
                    projectV2(number: 10) { # æ›¿æ¢ä¸ºä½ çš„é¡¹ç›®ç¼–å·ï¼Œæˆ–ç”¨ name: "EQT Collective Intelligence Pipeline"
                      id
                      title
                      fields(first: 30) { # æ‰©å¤§æŸ¥è¯¢æ•°é‡ï¼ŒåŒ…å«è‡ªå®šä¹‰å­—æ®µ
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options { id, name } # çŠ¶æ€/ä¼˜å…ˆçº§ç­‰å•é€‰å­—æ®µçš„é€‰é¡¹
                          }
                          ... on ProjectV2NumberField { # WIPé™åˆ¶å­—æ®µï¼ˆéœ€æå‰åœ¨é¡¹ç›®ä¸­åˆ›å»ºï¼‰
                            id
                            name
                          }
                        }
                      }
                      items(first: 100) { # æŸ¥è¯¢æ‰€æœ‰é¡¹ç›®é¡¹ï¼Œç”¨äºŽWIPæ ¡éªŒ
                        nodes {
                          id
                          fieldValues(first: 10) {
                            nodes {
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                field { id, name }
                                optionId
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const { repository } = await github.graphql(projectQuery);
              const projectV2 = repository.projectV2;
              
              if (!projectV2) {
                console.log('âŒ æœªæ‰¾åˆ°é¡¹ç›®ã€ŒEQT Collective Intelligence Pipelineã€ï¼Œè¯·æ£€æŸ¥é¡¹ç›®ç¼–å·/åç§°');
                return;
              }
              console.log(`âœ… æ‰¾åˆ°é¡¹ç›®ï¼š${projectV2.title}ï¼ˆIDï¼š${projectV2.id}ï¼‰`);

              // 2. æå–æ ¸å¿ƒå­—æ®µï¼ˆçŠ¶æ€å­—æ®µ + WIPé™åˆ¶å­—æ®µï¼‰
              const statusField = projectV2.fields.nodes.find(field => 
                field.name.toLowerCase().includes('status') || field.name.includes('çŠ¶æ€')
              );
              const wipLimitField = projectV2.fields.nodes.find(field => 
                field.name.toLowerCase().includes('wip limit') || field.name.includes('wipé™åˆ¶')
              );
              
              if (!statusField) {
                console.log('âŒ æœªæ‰¾åˆ°ã€ŒçŠ¶æ€ã€å­—æ®µï¼Œè¯·åœ¨é¡¹ç›®ä¸­åˆ›å»ºå•é€‰å­—æ®µï¼ˆåç§°å«Status/çŠ¶æ€ï¼‰');
                return;
              }
              console.log(`âœ… æ‰¾åˆ°çŠ¶æ€å­—æ®µï¼š${statusField.name}ï¼ˆIDï¼š${statusField.id}ï¼‰`);

              // ========================= 3. å…¨é˜¶æ®µçŠ¶æ€æ˜ å°„é…ç½® =========================
              // å®Œå…¨åŒ¹é…è®¾è®¡æ–‡ä»¶çš„6ä¸ªé˜¶æ®µï¼ŒåŒ…å«è§¦å‘æ¡ä»¶å®šä¹‰
              const stageConfig = {
                seed: { // ðŸŒ± æ–°èŠ½
                  name: 'ðŸŒ± æ–°èŠ½ (Seed)',
                  trigger: () => {
                    // è§¦å‘æ¡ä»¶ï¼š1. æ–°Issue 2. æ— ä»»ä½•åŒ¹é…æ ‡ç­¾ 3. æœªå…³é—­
                    const isNewIssue = context.eventName === 'issues' && context.payload.action === 'opened';
                    const hasNoMatchLabel = !Object.keys(stageConfig).some(key => 
                      key !== 'seed' && (issue?.labels || []).some(l => l.name.toLowerCase().includes(key))
                    );
                    return contentType === 'Issue' && !isIssueClosed && (isNewIssue || hasNoMatchLabel);
                  }
                },
                exploring: { // ðŸ” è®ºè¯ä¸­
                  name: 'ðŸ” è®ºè¯ä¸­ (Exploring)',
                  trigger: () => (issue?.labels || pr?.labels).some(l => l.name.toLowerCase().includes('exploring'))
                },
                validating: { // ðŸ§ª éªŒè¯ä¸­
                  name: 'ðŸ§ª éªŒè¯ä¸­ (Validating)',
                  trigger: () => {
                    // è§¦å‘æ¡ä»¶ï¼š1. PRå…³è”EQT-Dataä»“åº“ 2. æ ‡ç­¾å«validating
                    const linksEqtData = pr?.body?.includes('EQT-Data') || pr?.head?.repo?.name === 'EQT-Data';
                    const hasValidatingLabel = (issue?.labels || pr?.labels).some(l => l.name.toLowerCase().includes('validating'));
                    return linksEqtData || hasValidatingLabel;
                  }
                },
                reviewing: { // ðŸ¤ ç¤¾åŒºè¯„å®¡
                  name: 'ðŸ¤ ç¤¾åŒºè¯„å®¡ (Reviewing)',
                  trigger: () => (issue?.labels || pr?.labels).some(l => l.name.toLowerCase().includes('reviewing'))
                },
                consensus: { // âœ… åˆæ­¥å…±è¯†
                  name: 'âœ… åˆæ­¥å…±è¯† (Consensus)',
                  trigger: () => (issue?.labels || pr?.labels).some(l => l.name.toLowerCase().includes('consensus'))
                },
                integration: { // ðŸŽ¯ æ ¸å¿ƒæ•´åˆ
                  name: 'ðŸŽ¯ æ ¸å¿ƒæ•´åˆ (Integration)',
                  trigger: () => pr?.state === 'closed' && pr?.merged === true // PRåˆå¹¶è§¦å‘
                },
                archived: { // ðŸ“‹ å·²å½’æ¡£
                  name: 'ðŸ“‹ å·²å½’æ¡£ (Archived)',
                  trigger: () => isIssueClosed // Issueå…³é—­è§¦å‘
                }
              };

              // ========================= 4. åŒ¹é…ç›®æ ‡çŠ¶æ€ =========================
              let targetStage = null;
              // éåŽ†æ‰€æœ‰é˜¶æ®µï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³è§¦å‘æ¡ä»¶çš„é˜¶æ®µ
              Object.values(stageConfig).forEach(stage => {
                if (!targetStage && stage.trigger()) targetStage = stage;
              });
              
              if (!targetStage) {
                console.log('â„¹ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„é˜¶æ®µï¼Œä¿æŒå½“å‰çŠ¶æ€');
                return;
              }
              console.log(`ðŸ”„ åŒ¹é…ç›®æ ‡é˜¶æ®µï¼š${targetStage.name}`);

              // éªŒè¯ç›®æ ‡é˜¶æ®µåœ¨é¡¹ç›®ä¸­å­˜åœ¨
              const targetOption = statusField.options.find(opt => opt.name === targetStage.name);
              if (!targetOption) {
                console.log(`âŒ é¡¹ç›®ä¸­æ— ã€Œ${targetStage.name}ã€çŠ¶æ€é€‰é¡¹`);
                console.log('å¯ç”¨çŠ¶æ€é€‰é¡¹ï¼š', statusField.options.map(o => o.name).join(', '));
                return;
              }

              // ========================= 5. WIPé™åˆ¶æ ¡éªŒï¼ˆæ–°å¢žï¼‰ =========================
              let isWipExceeded = false;
              if (wipLimitField && targetStage.name !== 'ðŸ“‹ å·²å½’æ¡£ (Archived)' && targetStage.name !== 'ðŸŽ¯ æ ¸å¿ƒæ•´åˆ (Integration)') {
                // 1. èŽ·å–ç›®æ ‡é˜¶æ®µçš„WIPé™åˆ¶å€¼ï¼ˆéœ€åœ¨é¡¹ç›®å­—æ®µä¸­æ‰‹åŠ¨è®¾ç½®ï¼Œå¦‚ã€ŒðŸŒ± æ–°èŠ½ã€è®¾ä¸º10ï¼‰
                const targetStageWipLimit = await github.graphql(`
                  query($projectId: ID!, $fieldId: ID!, $stageName: String!) {
                    node(id: $projectId) {
                      ... on ProjectV2 {
                        field(name: $stageName) {
                          ... on ProjectV2SingleSelectField {
                            id
                            options(first: 1) {
                              nodes {
                                fieldValues(first: 1) {
                                  nodes {
                                    ... on ProjectV2ItemFieldNumberValue {
                                      number
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                `, {
                  projectId: projectV2.id,
                  fieldId: wipLimitField.id,
                  stageName: targetStage.name
                });

                const wipLimit = targetStageWipLimit.node.field.options.nodes[0]?.fieldValues.nodes[0]?.number || 0;
                if (wipLimit > 0) {
                  // 2. ç»Ÿè®¡å½“å‰é˜¶æ®µçš„å¡ç‰‡æ•°é‡
                  const currentStageItems = projectV2.items.nodes.filter(item => {
                    const statusValue = item.fieldValues.nodes.find(v => 
                      v.field.id === statusField.id && v.optionId === targetOption.id
                    );
                    return !!statusValue;
                  });

                  // 3. æ ¡éªŒæ˜¯å¦è¶…è¿‡é™åˆ¶ï¼ˆ+1æ˜¯å› ä¸ºå½“å‰å¡ç‰‡å³å°†åŠ å…¥ï¼‰
                  if (currentStageItems.length + 1 > wipLimit) {
                    isWipExceeded = true;
                    console.log(`âš ï¸ WIPé™åˆ¶è­¦å‘Šï¼š${targetStage.name} æœ€å¤š${wipLimit}ä¸ªå¡ç‰‡ï¼Œå½“å‰å·²${currentStageItems.length}ä¸ª`);
                    // å¯é€‰ï¼šè¶…è¿‡WIPæ—¶ç»ˆæ­¢æ›´æ–°ï¼Œæˆ–å‘é€é€šçŸ¥
                    // return; 
                  }
                }
              }

              // ========================= 6. é¡¹ç›®é¡¹æŸ¥è¯¢ä¸ŽçŠ¶æ€æ›´æ–° =========================
              // 1. ç”ŸæˆContent IDï¼ˆGitHub Projectsè¯†åˆ«Issue/PRçš„å”¯ä¸€æ ‡è¯†ï¼‰
              const contentId = `${contentType}:${context.repo.owner}/${context.repo.repo}#${contentNumber}`;
              
              // 2. æŸ¥è¯¢å½“å‰å†…å®¹å¯¹åº”çš„é¡¹ç›®é¡¹
              const itemQuery = `
                query($projectId: ID!, $contentId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 1, contentId: $contentId) {
                        nodes { id }
                      }
                    }
                  }
                }
              `;
              
              const { node } = await github.graphql(itemQuery, {
                projectId: projectV2.id,
                contentId: contentId
              });
              
              const projectItem = node.items.nodes[0];
              if (!projectItem) {
                console.log(`â„¹ï¸ æœªæ‰¾åˆ°${contentType}#${contentNumber}å¯¹åº”çš„é¡¹ç›®é¡¹ï¼Œéœ€æ‰‹åŠ¨æ·»åŠ åˆ°çœ‹æ¿`);
                return;
              }
              console.log(`âœ… æ‰¾åˆ°é¡¹ç›®é¡¹ï¼š${projectItem.id}`);

              // 3. æ‰§è¡ŒçŠ¶æ€æ›´æ–°
              const updateMutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $valueId: ID!) {
                  updateProjectV2SingleSelectField(
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    valueId: $valueId
                  ) {
                    projectV2Item { id }
                  }
                }
              `;
              
              await github.graphql(updateMutation, {
                projectId: projectV2.id,
                itemId: projectItem.id,
                fieldId: statusField.id,
                valueId: targetOption.id
              });

              // ========================= 7. æ‰§è¡Œç»“æžœè¾“å‡º =========================
              console.log(`ðŸŽ‰ çŠ¶æ€æ›´æ–°å®Œæˆï¼`);
              console.log(`- é¡¹ç›®é¡¹ï¼š${projectItem.id}`);
              console.log(`- ç›®æ ‡é˜¶æ®µï¼š${targetStage.name}`);
              if (isWipExceeded) console.log(`- æ³¨æ„ï¼šå½“å‰é˜¶æ®µå·²æŽ¥è¿‘WIPé™åˆ¶ï¼Œè¯·ä¼˜å…ˆå¤„ç†å­˜é‡å¡ç‰‡`);

            } catch (error) {
              console.error('âŒ è‡ªåŠ¨åŒ–æµç¨‹å¤±è´¥ï¼š', error.message);
              if (error.errors) console.error('ðŸ“ GraphQLé”™è¯¯è¯¦æƒ…ï¼š', JSON.stringify(error.errors, null, 2));
              throw error; // æŠ›å‡ºé”™è¯¯ä»¥åœ¨GitHub Actionsç•Œé¢æ˜¾ç¤ºå¤±è´¥
            }

  ai-bot-trigger:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'ðŸŒ± seed') # ä»…æ–°èŠ½é˜¶æ®µè§¦å‘AI
    steps:
      - name: Trigger EQT AI Bot Analysis
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            console.log(`ðŸ¤– è§¦å‘AIåˆ†æžï¼šæ–°èŠ½è®®é¢˜ #${issue.number}ã€Š${issue.title}ã€‹`);

            // ========================= AI Botè°ƒç”¨é€»è¾‘ï¼ˆå¯æ ¹æ®å®žé™…æŽ¥å£è°ƒæ•´ï¼‰ =========================
            try {
              // 1. æž„é€ AIåˆ†æžè¯·æ±‚å‚æ•°ï¼ˆåŒ…å«è®®é¢˜æ ¸å¿ƒå…ƒæ•°æ®ï¼‰
              const aiRequestData = {
                issueId: issue.id,
                issueNumber: issue.number,
                title: issue.title,
                body: issue.body,
                labels: issue.labels.map(l => l.name),
                createdBy: issue.user.login,
                createdAt: issue.created_at
              };

              // 2. è°ƒç”¨AI Bot APIï¼ˆæ›¿æ¢ä¸ºä½ çš„å®žé™…æŽ¥å£ï¼Œéœ€é…ç½®ç§˜é’¥ï¼‰
              const aiBotToken = process.env.AI_BOT_TOKEN;
              if (!aiBotToken) {
                console.log('âš ï¸ æœªé…ç½®AI_BOT_TOKENï¼Œè·³è¿‡AIè°ƒç”¨');
                return;
              }

              const response = await fetch('https://your-eqt-ai-bot.com/analyze-seed', { // æ›¿æ¢ä¸ºå®žé™…æŽ¥å£
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${aiBotToken}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(aiRequestData)
              });

              if (response.ok) {
                const aiResult = await response.json();
                console.log(`âœ… AIåˆ†æžè¯·æ±‚æˆåŠŸï¼Œåˆ†æžIDï¼š${aiResult.analysisId}`);
                
                // å¯é€‰ï¼šå°†AIç»“æžœè¯„è®ºåˆ°Issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ðŸ¤– EQT-AI-Bot å·²æŽ¥æ”¶åˆ†æžè¯·æ±‚ï¼ˆIDï¼š${aiResult.analysisId}ï¼‰ï¼Œç»“æžœå°†åœ¨1-2åˆ†é’Ÿå†…æ›´æ–°ã€‚`
                });
              } else {
                console.error(`âŒ AIè°ƒç”¨å¤±è´¥ï¼š${response.statusText}`);
              }
            } catch (aiError) {
              console.error('âŒ AI Botè§¦å‘å¼‚å¸¸ï¼š', aiError.message);
            }                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                          ... on ProjectV2FieldCommon {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const { node: projectNode } = await github.graphql(fieldsQuery, {
                projectId: targetProject.id
              });
              
              const fields = projectNode.fields.nodes;
              const statusField = fields.find(field => 
                field.name.toLowerCase().includes('status') || 
                field.name.includes('çŠ¶æ€') ||
                field.name.includes('é˜¶æ®µ')
              );
              
              if (!statusField || !statusField.options) {
                console.log('âŒ æœªæ‰¾åˆ° Status å•é€‰å­—æ®µ');
                console.log('å¯ç”¨å­—æ®µ:');
                fields.forEach(f => {
                  console.log(`  - ${f.name} (${f.__typename})`);
                  if (f.options) {
                    console.log(`    é€‰é¡¹: ${f.options.map(o => o.name).join(', ')}`);
                  }
                });
                return;
              }
              
              console.log(`âœ… æ‰¾åˆ°çŠ¶æ€å­—æ®µ: ${statusField.name} (ID: ${statusField.id})`);
              console.log(`çŠ¶æ€é€‰é¡¹: ${statusField.options.map(o => o.name).join(', ')}`);

              // æ ‡ç­¾åˆ°çŠ¶æ€çš„æ˜ å°„ï¼ˆç¡®ä¿ä¸Žé¡¹ç›®é€‰é¡¹å®Œå…¨åŒ¹é…ï¼‰
              const labelToStatus = {
                'exploring': 'ðŸ” è®ºè¯ä¸­ (Exploring)',
                'reviewing': 'ðŸ¤ ç¤¾åŒºè¯„å®¡ (Reviewing)', 
                'consensus': 'âœ… åˆæ­¥å…±è¯† (Consensus)',
                'integration': 'ðŸŽ¯ æ ¸å¿ƒæ•´åˆ (Integration)'
              };

              // èŽ·å–å½“å‰æ ‡ç­¾
              const labels = issue?.labels || pr?.labels || [];
              console.log(`â„¹ï¸ å½“å‰æ ‡ç­¾: ${labels.map(l => l.name).join(', ') || 'æ— æ ‡ç­¾'}`);

              // æŸ¥æ‰¾åŒ¹é…çš„æ ‡ç­¾
              let targetStatusName = null;
              for (const [labelKey, statusName] of Object.entries(labelToStatus)) {
                if (labels.some(l => l.name.toLowerCase().includes(labelKey))) {
                  targetStatusName = statusName;
                  console.log(`âœ… åŒ¹é…æ ‡ç­¾: ${labelKey} -> ${statusName}`);
                  break;
                }
              }
              
              if (!targetStatusName) {
                console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„çŠ¶æ€æ ‡ç­¾ï¼Œè·³è¿‡æ›´æ–°');
                return;
              }

              // æŸ¥æ‰¾ç›®æ ‡çŠ¶æ€é€‰é¡¹
              const targetOption = statusField.options.find(opt => 
                opt.name === targetStatusName
              );
              
              if (!targetOption) {
                console.log(`âŒ æœªæ‰¾åˆ°çŠ¶æ€é€‰é¡¹: ${targetStatusName}`);
                console.log('å¯ç”¨é€‰é¡¹:', statusField.options.map(o => o.name));
                return;
              }
              
              console.log(`âœ… æ‰¾åˆ°ç›®æ ‡é€‰é¡¹: ${targetOption.name} (ID: ${targetOption.id})`);

              // æ­¥éª¤3: æ£€æŸ¥é¡¹ç›®é¡¹æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ·»åŠ 
              const contentId = `${contentType}:${context.repo.owner}/${context.repo.repo}#${contentNumber}`;
              console.log(`â„¹ï¸ Content ID: ${contentId}`);
              
              const itemQuery = `
                query($projectId: ID!, $contentId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 10, contentId: $contentId) {
                        nodes {
                          id
                          content {
                            ... on Issue {
                              number
                              title
                            }
                            ... on PullRequest {
                              number
                              title
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const { node: itemNode } = await github.graphql(itemQuery, {
                projectId: targetProject.id,
                contentId: contentId
              });
              
              let projectItem = itemNode.items.nodes[0];
              
              // å¦‚æžœé¡¹ç›®é¡¹ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨æ·»åŠ 
              if (!projectItem) {
                console.log(`âš ï¸ æœªæ‰¾åˆ°é¡¹ç›®é¡¹ for ${contentId}ï¼Œå°è¯•æ·»åŠ ...`);
                
                const addItemMutation = `
                  mutation($projectId: ID!, $contentId: ID!) {
                    addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                      item {
                        id
                        content {
                          ... on Issue {
                            number
                            title
                          }
                          ... on PullRequest {
                            number
                            title
                          }
                        }
                      }
                    }
                  }
                `;
                
                const addResult = await github.graphql(addItemMutation, {
                  projectId: targetProject.id,
                  contentId: contentId
                });
                
                projectItem = addResult.addProjectV2ItemById.item;
                console.log(`âœ… æˆåŠŸæ·»åŠ é¡¹ç›®é¡¹: ${projectItem.id}`);
              } else {
                console.log(`âœ… æ‰¾åˆ°é¡¹ç›®é¡¹: ${projectItem.id} (${projectItem.content.title})`);
              }

              // æ­¥éª¤4: æ›´æ–°çŠ¶æ€
              const updateMutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $valueId: ID!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $valueId }
                  }) {
                    projectV2Item {
                      id
                      fieldValues(first: 10) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const { updateProjectV2ItemFieldValue } = await github.graphql(updateMutation, {
                projectId: targetProject.id,
                itemId: projectItem.id,
                fieldId: statusField.id,
                valueId: targetOption.id
              });
              
              console.log(`ðŸŽ‰ æˆåŠŸæ›´æ–°çŠ¶æ€ä¸º: ${targetStatusName}`);
              console.log(`é¡¹ç›®é¡¹ ID: ${projectItem.id}`);

            } catch (error) {
              console.error('âŒ æ‰§è¡Œå¤±è´¥:', error.message);
              if (error.errors) {
                error.errors.forEach(err => {
                  console.error(`GraphQL é”™è¯¯: ${err.message}`);
                  if (err.path) console.error(`è·¯å¾„: ${err.path.join('.')}`);
                });
              }
              console.error('å®Œæ•´é”™è¯¯:', JSON.stringify(error, null, 2));
              throw error;
            }
