name: EQT Kanban Advanced Automation (Final Runnable Version)

on:
  workflow_dispatch:
    inputs:
      contentType:
        description: 'Content Type'
        required: true
        default: 'Issue'
        type: choice
        options:
        - Issue
        - PullRequest
      contentNumber:
        description: 'Content Number'
        required: true
        type: number
      triggerAI:
        description: 'Trigger AI Bot'
        required: false
        type: boolean
        default: false
  issues:
    types: [opened, labeled, unlabeled, closed, reopened, edited]
  pull_request:
    types: [opened, closed, reopened, ready_for_review, edited, labeled, unlabeled]
  project_card:
    types: [created, moved, deleted]

jobs:
  sync-status-full:
    runs-on: ubuntu-latest
    steps:
      - name: Sync labels to status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const manualInput = context.payload.inputs;
            let issue = context.payload.issue;
            let pr = context.payload.pull_request;
            let contentType, contentNumber, isIssueClosed;

            if (context.eventName === 'workflow_dispatch' && manualInput?.contentType && manualInput?.contentNumber) {
              contentType = manualInput.contentType;
              contentNumber = parseInt(manualInput.contentNumber);
              isIssueClosed = false;
              console.log(`ğŸ“¥ æ‰‹åŠ¨è§¦å‘ï¼šå¤„ç† ${contentType} #${contentNumber}`);
            } else {
              contentType = issue ? 'Issue' : 'PullRequest';
              contentNumber = issue?.number || pr?.number;
              isIssueClosed = issue?.state === 'closed';
              if (!contentNumber) {
                console.log('âŒ æœªæ‰¾åˆ°æœ‰æ•ˆ Issue æˆ– PRï¼Œç»ˆæ­¢æµç¨‹');
                return;
              }
              console.log(`ğŸ“¥ è‡ªåŠ¨è§¦å‘ï¼šå¤„ç† ${contentType} #${contentNumber}`);
            }

            try {
              // âœ… ä¿®æ­£GraphQLè¯­æ³•ï¼šä½¿ç”¨å®Œæ•´çš„å­—æ®µå
              const projectQuery = `query {
                repository(owner: "EQTResearcher", name: "EQT-Collaboration") {
                  projectV2(number: 10) {
                    id
                    title
                    fields(first: 30) {
                      nodes {
                        ... on ProjectV2SingleSelectFieldConfiguration {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                        ... on ProjectV2NumberFieldConfiguration {
                          id
                          name
                        }
                        ... on ProjectV2FieldCommon {
                          id
                          name
                          dataType
                        }
                      }
                    }
                    items(first: 100) {
                      nodes {
                        id
                        fieldValues(first: 10) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              field {
                                id
                                name
                              }
                              optionId
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }`;
              
              console.log('ğŸ” æŸ¥è¯¢é¡¹ç›®ä¿¡æ¯...');
              const { repository } = await github.graphql(projectQuery);
              const projectV2 = repository.projectV2;
              
              if (!projectV2) {
                console.log('âŒ æœªæ‰¾åˆ°é¡¹ç›®ï¼ˆæ£€æŸ¥ä»“åº“ï¼šEQTResearcher/EQT-Collaborationï¼Œé¡¹ç›®ç¼–å·ï¼š10ï¼‰');
                console.log('è¯·ç¡®è®¤ï¼š1.é¡¹ç›®å·²è¿ç§»åˆ°æ–°ç³»ç»Ÿ 2.é¡¹ç›®ç¼–å·æ­£ç¡® 3.æœ‰è®¿é—®æƒé™');
                return;
              }
              console.log(`âœ… æ‰¾åˆ°é¡¹ç›®ï¼š${projectV2.title} (ID: ${projectV2.id})`);

              // æŸ¥æ‰¾çŠ¶æ€å­—æ®µ
              const statusField = projectV2.fields.nodes.find(field => 
                field.name.toLowerCase().includes('status') || 
                field.name.toLowerCase().includes('çŠ¶æ€') ||
                field.name.toLowerCase().includes('é˜¶æ®µ')
              );
              
              if (!statusField || !statusField.options) {
                console.log('âŒ æœªæ‰¾åˆ°çŠ¶æ€å•é€‰å­—æ®µ');
                console.log('å¯ç”¨å­—æ®µï¼š');
                projectV2.fields.nodes.forEach(f => {
                  console.log(`  - ${f.name} (${f.__typename || 'æœªçŸ¥'})`);
                  if (f.options) {
                    console.log(`    é€‰é¡¹ï¼š${f.options.map(o => o.name).join(', ')}`);
                  }
                });
                return;
              }
              console.log(`âœ… æ‰¾åˆ°çŠ¶æ€å­—æ®µï¼š${statusField.name}`);
              console.log(`çŠ¶æ€é€‰é¡¹ï¼š${statusField.options.map(o => o.name).join(', ')}`);

              // é˜¶æ®µé…ç½®
              const stageConfig = {
                seed: { 
                  name: 'ğŸŒ± æ–°èŠ½ (Seed)',
                  trigger: () => {
                    if (context.eventName === 'workflow_dispatch') return true;
                    const isNewIssue = context.eventName === 'issues' && context.payload.action === 'opened';
                    const hasNoMatchLabel = !Object.keys(stageConfig).some(key => 
                      key !== 'seed' && (issue?.labels || []).some(l => l.name.toLowerCase().includes(key))
                    );
                    return contentType === 'Issue' && !isIssueClosed && (isNewIssue || hasNoMatchLabel);
                  }
                },
                exploring: { 
                  name: 'ğŸ” è®ºè¯ä¸­ (Exploring)',
                  trigger: () => (issue?.labels || pr?.labels || []).some(l => l.name.toLowerCase().includes('exploring'))
                },
                validating: { 
                  name: 'ğŸ§ª éªŒè¯ä¸­ (Validating)',
                  trigger: () => {
                    const linksEqtData = pr?.body?.includes('EQT-Data') || pr?.head?.repo?.name === 'EQT-Data';
                    const hasValidatingLabel = (issue?.labels || pr?.labels || []).some(l => l.name.toLowerCase().includes('validating'));
                    return linksEqtData || hasValidatingLabel;
                  }
                },
                reviewing: { 
                  name: 'ğŸ¤ ç¤¾åŒºè¯„å®¡ (Reviewing)',
                  trigger: () => (issue?.labels || pr?.labels || []).some(l => l.name.toLowerCase().includes('reviewing'))
                },
                consensus: { 
                  name: 'âœ… åˆæ­¥å…±è¯† (Consensus)',
                  trigger: () => (issue?.labels || pr?.labels || []).some(l => l.name.toLowerCase().includes('consensus'))
                },
                integration: { 
                  name: 'ğŸ¯ æ ¸å¿ƒæ•´åˆ (Integration)',
                  trigger: () => pr?.state === 'closed' && pr?.merged === true
                },
                archived: { 
                  name: 'ğŸ“‹ å·²å½’æ¡£ (Archived)',
                  trigger: () => isIssueClosed
                }
              };

              // æŸ¥æ‰¾åŒ¹é…é˜¶æ®µ
              let targetStage = null;
              for (const [key, stage] of Object.entries(stageConfig)) {
                if (stage.trigger()) {
                  targetStage = stage;
                  console.log(`ğŸ”„ åŒ¹é…é˜¶æ®µï¼š${key} -> ${targetStage.name}`);
                  break;
                }
              }
              
              if (!targetStage) {
                console.log('â„¹ï¸ æœªæ‰¾åˆ°åŒ¹é…é˜¶æ®µï¼Œä¿æŒå½“å‰çŠ¶æ€');
                return;
              }

              // ç¡®ä¿ç›®æ ‡é€‰é¡¹å­˜åœ¨
              const targetOption = statusField.options.find(opt => opt.name === targetStage.name);
              if (!targetOption) {
                console.log(`âŒ é¡¹ç›®ä¸­æ— çŠ¶æ€é€‰é¡¹ã€Œ${targetStage.name}ã€`);
                console.log('å¯ç”¨é€‰é¡¹ï¼š', statusField.options.map(o => o.name));
                return;
              }

              // æŸ¥è¯¢é¡¹ç›®é¡¹
              const contentId = `${contentType}:EQTResearcher/EQT-Collaboration#${contentNumber}`;
              console.log(`ğŸ” æŸ¥è¯¢é¡¹ç›®é¡¹ï¼š${contentId}`);
              
              const itemQuery = `query($projectId: ID!, $contentId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 1, contentId: $contentId) {
                      nodes {
                        id
                      }
                    }
                  }
                }
              }`;
              
              const { node } = await github.graphql(itemQuery, {
                projectId: projectV2.id,
                contentId: contentId
              });
              
              const projectItem = node.items?.nodes[0];
              if (!projectItem) {
                console.log(`âŒ æœªæ‰¾åˆ° ${contentType}#${contentNumber} çš„é¡¹ç›®é¡¹`);
                console.log('è¯·æ‰‹åŠ¨å°† Issue/PR æ·»åŠ åˆ°é¡¹ç›®ä¸­ï¼Œæˆ–æ£€æŸ¥ contentId æ ¼å¼');
                return;
              }
              console.log(`âœ… æ‰¾åˆ°é¡¹ç›®é¡¹ï¼š${projectItem.id}`);

              // æ›´æ–°çŠ¶æ€
              const updateMutation = `mutation updateProjectStatus($projectId: ID!, $itemId: ID!, $fieldId: ID!, $valueId: ID!) {
                updateProjectV2SingleSelectField(
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  valueId: $valueId
                ) {
                  projectV2Field {
                    ... on ProjectV2SingleSelectField {
                      name
                    }
                  }
                }
              }`;
              
              const updateResult = await github.graphql(updateMutation, {
                projectId: projectV2.id,
                itemId: projectItem.id,
                fieldId: statusField.id,
                valueId: targetOption.id
              });

              console.log(`ğŸ‰ çŠ¶æ€æ›´æ–°æˆåŠŸï¼š${targetStage.name}`);
              console.log(`é¡¹ç›®é¡¹ IDï¼š${projectItem.id}`);

            } catch (error) {
              console.error('âŒ æ‰§è¡Œå¤±è´¥ï¼š', error.message);
              if (error.errors) {
                error.errors.forEach(err => {
                  console.error(`GraphQLé”™è¯¯ï¼š${err.message}`);
                });
              }
              throw error;
            }

  ai-bot-trigger:
    runs-on: ubuntu-latest
    needs: sync-status-full
    if: |
      contains(github.event.issue.labels.*.name, 'ğŸŒ± seed') || 
      (github.eventName === 'workflow_dispatch' && github.event.inputs.triggerAI === 'true')
    steps:
      - name: Trigger EQT AI Bot
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const manualInput = context.payload.inputs;
            let issueNumber = manualInput?.contentNumber || context.payload.issue?.number;
            
            if (!issueNumber) {
              console.log('âŒ æ— Issueç¼–å·ï¼Œæ— æ³•è§¦å‘AI');
              return;
            }
            
            console.log(`ğŸ¤– è§¦å‘AIåˆ†æï¼šIssue #${issueNumber}`);

            try {
              // æ£€æŸ¥ç¯å¢ƒå˜é‡
              const aiBotToken = process.env.AI_BOT_TOKEN;
              if (!aiBotToken) {
                console.log('âš ï¸ æœªé…ç½® AI_BOT_TOKENï¼Œè·³è¿‡AIè°ƒç”¨');
                console.log('è¯·åœ¨ä»“åº“è®¾ç½®ä¸­æ·»åŠ  AI_BOT_TOKEN ç¯å¢ƒå˜é‡');
                return;
              }

              // è·å–Issueè¯¦æƒ…
              const { data: issueData } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });

              const response = await fetch('https://your-eqt-ai-bot.com/analyze-seed', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${aiBotToken}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  issueNumber: issueNumber,
                  title: issueData.title,
                  body: issueData.body,
                  labels: issueData.labels.map(l => l.name),
                  url: issueData.html_url
                })
              });

              if (response.ok) {
                const result = await response.json();
                console.log(`âœ… AIåˆ†æè¯·æ±‚æˆåŠŸï¼š${JSON.stringify(result)}`);
              } else {
                console.error(`âŒ AIè°ƒç”¨å¤±è´¥ï¼š${response.status} ${response.statusText}`);
                console.error(`å“åº”å†…å®¹ï¼š${await response.text()}`);
              }
            } catch (error) {
              console.error('âŒ AIè§¦å‘å¼‚å¸¸ï¼š', error.message);
            }
